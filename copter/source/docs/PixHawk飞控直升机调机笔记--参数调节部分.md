# PixHawk飞控直升机调机笔记--参数调节部分



## 一、总体说明

* 此教程参数调节部分只针对于Copter3.4 以及以上的固件，因为更早的固件中参数名可能可能和3.6之后的固件不一样，所以请升级至3.6之后的固件，或者参考别的教程。

* 请注意，在针对传统的直升机做参数调整的时候，==请使用地面站中的“全部参数表”（full or complete parameter list)==。**不要使用“基础调参设置”和“高级参数设置”等页面**，这些页面是为了多轴飞行器设计的，使用这些页面会对一些参数造成改变，这些参数的改变可能会对直升机造成想不到的后果。最后还要记住，在所有参数页更改了参数之后记得点击**写入更改（write changes）**，否则飞控将不会保存更改。



## 二、基本飞控控制算法说明

####TODO：第二部分是PID算法说明，没有翻译完，调参从第三部分开始，跳过这一部分不影响调参，请从第三部分开始阅读。

​      用户在调参之前需要大致了解飞控算法，概括的来说，飞控算法的设计为：将飞手的操作输入转换为一种姿态指令（增稳模式）或者将操作转换为一种比例指令（特技模式），从而控制飞行器到达想要的指令状态。在后台，飞控软件时刻监控及预测飞行器在飞手或者飞控输入下应该处在的空间位置（例如，俯仰和横滚姿态）。飞控有两套控制器（姿态和比例）合同协作，时刻保证飞行器按照软件预测的俯仰和横滚比率以及姿态。

​      飞手的指令转换为飞行器动作的整个过程首先受到到一个“最大允许加速度”的条件约束，这个约束可以通过**ATC_ACCEL_P_MAX**参数来调整**俯仰Pitch**的最大允许量（俯仰的动作幅度大小），**ATC_ACCEL_R_MAX**参数来调整**横滚Roll**的最大允许量（横滚的动作幅度大小）。飞行器最初的跟手手感（清脆或者懒惰）可以调整**RC_FEEL**参数。飞手的操作和这些参数被用来共同决定比例控制器的输出。

​      姿态控制器是用来确保飞行器实际的姿态和飞控预测的姿态一致，此控制器使用**ATV_ANG_PIT_P**（俯仰Pitch）和**ATC_ANG_RLL_P**（横滚Roll）两个参数来分别确定给比例控制器一个值，用来使飞行器达到飞控预测的姿态。

​		比例控制器同时收到飞手操作的指令和姿态控制器的给出的指令，比例控制器根据这两个指令计算解析出十字盘的动作。比例控制器使用PID控制算法以及前馈控制来输出需要的比例。前馈通路接收到飞手操作的比例信号时根据**ATC_RAT_PIT_VFF**增益（俯仰Pitch）和**ATC_RAT_RLL_VFF**增益（横滚Roll）来决定十字盘动作的大小。PID算法根据实际的动作比例和输入的的比例间的误差来决定十字盘的动作。这些控制指令合并到一起一起送到一个混合单元，这里决定舵机的动作。

​		所以调参的整体思路就是首先使用**VFF增益**来使想要得到的比例和实际的比例相同。但是，由于干扰的存在，想要得到的比例可能有很大的变化，PID中的P和D用来消除干扰。P和D可能无法完全使实际的比例正好达到想要得到的比例。由于飞控软件是追踪飞机头部的朝向，所以，任何可能使实际比例和请求不一样的误差都可能导致姿态的误差。所以

。。。。。。。



（这一章都是讲PID的。。。。）



（积分器I相关的两个参数**ATC_RAT_PIT_IMAX**（俯仰Pitch）和**ATC_RAT_RLL_IMAX**（横滚Roll））

（关于积分器泄漏的两个参数**ATC_RAT_PIT_ILMI**（俯仰Pitch）和**ATC_RAT_RLL_ILMI**（横滚Roll））

（为什么要用积分泄漏？  因为飞行器在悬停或者低速飞行的时候特别大的积分参数可能使飞行器倾覆）



## 二、俯仰（Pitch）和横滚（Roll）的初步调参

​		下面是你在调整你的飞行器的时候应该使用的一些初始参数。在使用下一部分有关偏航（Yaw）的参数来调整锁尾时，

​		将俯仰（Pitch）和横滚（Roll）的**VFF**参数调到**0.15**，这样直升机应该会比较好控制。

|      参数名      | 建议的初始值 |
| :--------------: | :----------: |
| ATC_ACCEL_P_MAX  |    110000    |
| ATC_ACCEL_R_MAX  |    110000    |
|  ATC_ANG_PIT_P   |     4.5      |
|  ATC_ANG_RLL_P   |     4.5      |
|  ATC_RAT_PIT_D   |      0       |
| ATC_RAT_PIT_FILT |      20      |
|  ATC_RAT_PIT_I   |      0       |
| ATC_RAT_PIT_ILMI |      0       |
| ATC_RAT_PIT_IMAX |     0.40     |
|  ATC_RAT_PIT_P   |      0       |
| ATC_RAT_PIT_VFF  |     0.15     |
|  ATC_RAT_RLL_D   |      0       |
| ATC_RAT_RLL_FILT |      20      |
|  ATC_RAT_RLL_I   |      0       |
| ATC_RAT_RLL_ILMI |      0       |
| ATC_RAT_RLL_IMAX |     0.40     |
|  ATC_RAT_RLL_P   |      0       |
| ATC_RAT_RLL_VFF  |     0.15     |
|     RC_FEEL      |      50      |

## 三、调整偏航（Yaw）

* **建议首先确保调整好偏航（锁尾）之后再对俯仰和横滚进行调整。**

* **重要事项**--飞控直升机和3D直升机不一样的是，飞控直升机通常都有比较低的旋翼转速和更大的十字盘负荷。

​      更低的旋翼转速意味着直升机的尾桨转速更低（机械传动的结构），也就意味着尾桨的动作效率更低。如果你的直升机负荷这样的条件的话，建议在第一次测试悬停前将**ATC_RAT_YAW_VFF**参数设置成0.05。

​	  下面是现有的和偏航有关的参数，启动你的直升机，让他悬停在不超过0.25米的高度上，使用自稳模式（Stabilize）来测试偏航有关的设置==如果飞机的尾巴看起来锁尾效果不好（尾巴松松垮垮的，不跟手），请调高**ATC_RAT_YAW_P**参数。如果尾巴左右来回摆动（金鱼尾），请调低**ATC_ANG_YAW_P**参数==

​	  在任何情况下都不推荐将**ATC_ANG_YAW_P**参数调低到3.5以下，不推荐将**ATC_RAT_YAW_P**调高到0.38以上。 如果你的直升机怎么调都不能够稳定锁尾的话，很可能是直升机有机械问题，建议检查锁尾舵机和尾舵机拉杆。在进行俯仰和横滚设置前请排除所有机械问题，设置好锁尾相关参数。

|     参数名称     | 建议的初始值 |
| :--------------: | :----------: |
| ATC_ACCEL_Y_MAX  |    27000     |
|  ATC_ANG_YAW_P   |     4.5      |
|  ATC_RAT_YAW_D   |    0.003     |
| ATC_RAT_YAW_FILT |      20      |
|  ATC_RAT_YAW_I   |     0.12     |
| ATC_RAT_YAW_ILMI |      0       |
| ATC_RAT_YAW_IMAX |     0.33     |
|  ATC_RAT_YAW_P   |     0.18     |
| ATC_RAT_YAW_VFF  |    0.024     |



## 四、设置VFF和ACCEL_MAX来得到想要的俯仰和横滚响应

​		在俯仰和滚转方向上，设置VFF增益使得实际飞行器速率与期望速率匹配。为此，需要日志中的RATE消息来比较俯仰的P.des和P信号以及横滚的R.des和R信号。将VFF增益设置为0.15，起飞并在稳定飞行模式中建立悬停，然后在俯仰和横滚方向上进行一些快速急促的打杆动作。着陆并从microSD卡中打开日志，查看地面站软件中的信号。如果实际费速率高于期望速率，那么请降低VFF。如果低于期望速率，增加VFF。如果所需和实际速率偏移一定数值，则意味着您的十字盘未正确调整或重心调整不正确。在这种情况下，只需确保速率的变化在期望值和实际值之间相似。如果您获得匹配的速率并且他们觉得它们太快，那么调小**ATC_ACCEL_MAX**参数并重复上述过程以匹配期望和实际速率。

​     如果在调整VFF增益时飞机开始振荡，则减小该轴的**ATC_ANG_xxx_P**增益（PIT、RLL），直到振荡停止。 但是对于大多数直升机而言，上面建议的值不应该导致这个问题。

​       对于有副翼旋翼头的直升机，建议在调整俯仰和滚转时以0.22 VFF作为开始，VFF可能需要更高。 但是==对于无副翼旋翼头的直升机，VFF应该不超过0.22==，除非你的舵机确实很慢或舵机臂的动力臂速度很慢。 对于所有直升机而言，VFF增益可以补偿伺服和连杆动力臂速度的差异。

​    **ATC_ACCEL_MAX**参数的设置取决于直升机的大小。 大型的800-900级直升机通常设置在36000-52000的范围内; 较小的450-500级直升机通常在90000-110000范围内。 您可能还想尝试**RC_FEEL**参数，以便按照您喜欢的方式获得飞机的初始响应。建议将**RC_FEEL**参数保持在**25到50**之间。一旦完成以下过程，飞机应该具有所需的手感和响应。

下面的图表显示了所需横滚速率与实际横滚速率的示例。峰值对应于输入的快速打杆动作，峰值的幅度（高度）应大致相同，偏移量不超过100毫秒。

![example1_1](/Users/changbowen/Storage/pilot-project/ardupilot_wiki/copter/source/images/TradHeli_tuning_example1_1.png)





---------------------------------

**PS.调整有副翼直升机的请注意 ** -- 对于有副翼的直升机，副翼本身是一个机械版比例PID回路。 因此，仅使用VFF调整副翼直升机的俯仰和横滚。 下面话题中提到的D和P增益率对于有副翼直升机来说请设置为0。 I-gain，IMAX和ILMI就像无副翼直升机一样调整。下面的表格是调整有副翼直升机的参考初始值，请初始把**ATC_RAT_RLL_VFF** 设置为 0.22。 该图显示了该飞机对姿态控制器的响应速率慢，意味着VFF值必须调高以实现适当的速率响应。 对于所有的有副翼直升机，==请确保设置**H_FLYBAR_MODE** 为 1==

![example3-1](/Users/changbowen/Storage/pilot-project/ardupilot_wiki/TradHeli_tuning_example3_1.png)

--------------------------------

## 五、调整D和P增益

​     一旦你根据以上步骤调整好了直升机对速率VFF增益的响应，现在就要开始调整PID增益。 PID控制器为飞行器提供稳定性以防止干扰，保持实际飞机遵循软件预测的姿态。

从D增益开始，使用ArduCopter的调整功能，用遥控器的6通道来调整D增益。请调整以下参数。

|   参数名    | 建议的初始值 |
| :---------: | :----------: |
|   TUNING    |      21      |
| TUNING_LOW  |      0       |
| TUNING_HIGH |     30*      |

* 注：对于Futaba的遥控器，以上的参数就相当于旋钮中的一个步进增量为0.001 *

调整6通道旋钮，直到**ATC_RAT_RLL_D**和**ATC_RAT_PIT_D**增益到0.001为止。 起飞并悬停，由于直升机的抖动通常出现在横滚方向上然后才出现在俯仰方向上，所以我们首先在横滚方向上调整。调整方法是：快速地在横滚通道打杆，如果它没有抖动，增加0.001的增益（旋钮旋大一点点）并再试一次。 在你打杆飞机出现摇晃的时候，记录增益的值，并将其的1/2作为**ATC_RAT_RLL_D**和**ATC_RAT_PIT_D**参数的值。 将直升机悬停并且在Pitch和Roll通道上都做一些快速的打杆动作，以检测飞机的稳定性。

接下来调整P增益，请调整为以下的参数。

|   参数名    | 建议的初始值 |
| :---------: | :----------: |
|   TUNING    |      4       |
| TUNING_LOW  |      0       |
| TUNING_HIGH |     300*     |

* 注：对于Futaba的遥控器，以上的参数就相当于旋钮中的一个步进增量为0.01 *

调整6通道旋钮，直到**ATC_RAT_RLL_P**和**ATC_RAT_PIT_P**增益到0.05为止。 起飞并悬停，快速的左右横滚打杆。 如果飞机没有晃动，增加0.01并再次尝试。 当你增加到某个数值时飞机快速摇晃，将该值减半，并将其作为**ATC_RAT_RLL_P**和**ATC_RAT_PIT_P**参数的最终调整值。 将直升机悬停并且在Pitch和Roll通道上都做一些快速的打杆动作，以检测飞机的稳定性。

在调整过P和D增益之后，你的直升机应该感觉非常顺滑了。

## 六、设置I增益、IMAX和ILMI

建议将**ATC_RAT_PIT_I**增益设置为和**ATC_RAT_PIT_VFF**增益相等，并且设置**ATC_RAT_RLL_I**增益等于**ATC_RAT_RLL_VFF**增益。 IMAX值限制积分器内可以储存的最大的误差，这个积分器用来抵消大的扰动造成的姿态误差。在俯仰轴上，这由积分器误差设定要求保持高前进速度飞机姿态。 初始值是0.4。 要检查这个设置，设置**IMAX= 1**，飞机前飞到你想要的最大速度。 打开日志并在PIDP消息查看I值的最大值。 将**IMAX**设置为高于最大值0.1。 横滚轴也做相同设置，但通常0.4应该足够。 **ILMI参数**的作用是限制积分的最大值来帮助在悬停时保持姿态， 建议此值不大于0.1。

下面的图描述的是ILMI参数设置为零的情况下，直升机在高速自主飞行时,预期的横滚轴姿态与实际的横滚轴姿态的关系。正确设置的I-gain和IMAX参数将使得直升机以超过5米/秒的速度飞行两秒以上的情况下直升机实际姿态可以非常接近预期姿态（我们称这种高速飞行为“动态飞行”）。 它应该使飞机保持在预期姿态1-2度的范围内。 在图的右侧飞行员使飞机悬停并切换Stabilize飞行模式。 您可以看到横滚轴方向上实际和期望的姿态之间存在差异。 这是将ILMI设置为零的后果。 ILMI可以被认为是悬停的一种“自动配平”，可以在飞机非动态飞行的状态下减少期望姿态和实际姿态的差异。

![example2_1](/Users/changbowen/Storage/pilot-project/ardupilot_wiki/TradHeli_tuning_example2_1.png)

##七、高级调参（悬停配平，悬停模式和航点模式）

* 调参到了这一步你的直升机应该已经非常稳定并且跟手了，接下来我们需要调整直升机使他在自稳模式下几乎可以在悬停的时候放手。还要调整I增益使直升机在航点模式下可以很好的根据航点调整姿态。

-----------------------

### 悬停配平：

在俯仰和横滚轴上配平直升机是保持飞机在Stabilize和Althold等模式下不漂移的重要一步。 横滚轴上的配平时靠尾桨推力来实现的。 所有的变矩尾桨直升机在悬停时根据主旋翼旋转方向的不同，要么左边的起落架低一点，要么右边的起落架低一点。ArduCopter软件有一个参数**ATC_HOVR_RLL_TRIM**用来消除这一现象。 纵向重心位置将影响俯仰轴方向的姿态修正配平。 没有参数告诉飞行控制器飞机在无漂移的悬停时是什么俯仰姿态。 它总是以传感器测量的机头方向与零度间距为修正目标。所以在悬停时，飞机可能机头向上无度，但是由于AHRS配平参数的设定，让飞行器认为他正在水平悬停。

因此为了配平飞机，首先将**ATC_HOVR_RLL_TRIM**参数设置为零。在装好飞控进行初始设置的时候，**AHRS_TRIM**的值在最后一步的加速度计校准期间将会自动设置（就是你水平放置飞机校准水平的那一步）。在做那一步的时候你应该保证你的主轴是完全的百分之百的竖直向上的。对于这个配平步骤，建议你按照以下步骤检查你的主轴是否是完全竖直向上的。

在与主轴垂直的机架部分上使用数字螺距尺进行俯仰和横滚轴的测量机架实际的角度。 连接到你的地面站软件与MavLink，注意飞行控制器检测到的俯仰和横滚轴的角度。 调整**AHRS_TRIM_X**和**AHRS_TRIM_Y**值使飞行控制器输出的俯仰和横滚轴的角度和你用电子螺距尺测量到的角度一致。 您可以在地面站中使用Level Horizon功能将直升机的水平和真实的水平对齐。 那个功能会为您自动调整**AHRS_TRIM**。

以上的操作是必要的，通过以上的操作我们可以准确地测量俯仰和滚动轴的角度来设定**ATC_HOVR_RLL_TRIM**。 飞行控制器现在就“知道”主轴何时完全垂直向上。

将你的直升机装配到正常载荷（也就是说设置好之后改变载荷可能需要重新设置，载荷包括但不限于像真机壳、云台、相机等），将直升机钱换到Stabilize自稳模式下，在无风的环境中悬停一会儿。 降落并打开日志，观察你为了保持直升机稳定悬停所遥控器摇杆所需要的输入量。 在**ATC_HOVR_RLL_TRIM**参数中输入此值（注意：以度数乘以100为单位）。举个例子：对于顺时针转动主旋翼，如果需要3.5度的向右横滚进行补偿，输入350。负值是逆时针转动的主旋翼左横滚的补偿值。

* **注意事项**-- 设置时千万不要使用遥控器上的通道配平，一定要确保遥控器上各个通道的trim都是0。

设置**ATC_HOVR_RLL_TRIM**之后，现在再次操作直升机悬停。 如果还是漂移，就对**SERVO1_TRIM**，**SERVO2_TRIM**和**SERVO3_TRIM**进行小的调整。
在静态设置直升机的时候就调整好十字盘使它完全水平是很困难的，以上的动态调整可以很好地帮助你调整好直升机。如果你需要把**SERVOx_TRIM**参数调整很大才能调平直升机的话，很有可能是你的飞机重心设置有问题，或者你一开始在静态设置的时候十字盘就没有很好的调平。

到现在为止，你的直升机应该已经调整的很好了，以上的调平步骤应该让你的直升机从一个很难操控的机器变成了一个非常像真的很好操纵的直升机。

#### 高速自主飞行的I增益调参

使用你的地面站软件为直升机设计一条航线吧，最好是8字航线，左右转弯都有，速度为6米/秒。 使用这个航线让直升机自主飞行，从microSD卡中打开日志，看看AHRS实际的Pitch、Roll和Yaw三个轴与预期的三个轴之间的差距。 他们的差距应该在1-2度以内。 如果不是的话，增加该轴的**ATC_RAT_xxx_I**值，直到它们之间的差距为1-2度以内为止。

现在，飞相同的航线，但这一次速度用9-10米/秒，并和上面一样的方法分析日志。 进一步根据需要调整I增益和IMAX值。 要根据自己的实验确定I增益的值，因为每一架直升机的设置都不一样。 但是，I增益在Pitch和Roll轴上通常为0.25-0.38，Yaw轴上普遍是0.18-0.30。IMAX值通常在0.40-0.45之间。

请参阅“六、设置I增益、IMAX和ILMII”部分，来准确设定IMAX的值

